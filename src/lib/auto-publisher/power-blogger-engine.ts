// ============================================================
// íŒŒì›Œë¸”ë¡œê±° ê¸€ì“°ê¸° ì—”ì§„ - 300ëª… íŒŒì›Œë¸”ë¡œê±° ë¶„ì„ ê¸°ë°˜
// ì‹¤ì œ íŒŒì›Œë¸”ë¡œê±°ì²˜ëŸ¼ ê¸€ì„ ì‘ì„±í•˜ëŠ” AI ì‹œìŠ¤í…œ
// ============================================================

import { callGeminiPremium } from '@/lib/gemini';
import type { TopicSuggestion } from './types';

// í˜„ì¬ ì—°ë„
const CURRENT_YEAR = new Date().getFullYear();

// 300ëª… íŒŒì›Œë¸”ë¡œê±° ë¶„ì„ ê¸°ë°˜ ê¸€ì“°ê¸° íŒ¨í„´
const POWER_BLOGGER_PATTERNS = {
  // ì„œë¡  íŒ¨í„´ (Hook)
  introPatterns: [
    'ê³µê°í˜•: ë…ìì˜ ê³ ë¯¼/ë¬¸ì œë¡œ ì‹œì‘ â†’ "í˜¹ì‹œ ì´ëŸ° ê²½í—˜ ìˆìœ¼ì‹ ê°€ìš”?"',
    'ì¶©ê²©í˜•: ë†€ë¼ìš´ í†µê³„/ì‚¬ì‹¤ë¡œ ì‹œì‘ â†’ "10ëª… ì¤‘ 8ëª…ì´ ëª¨ë¥´ëŠ” ì‚¬ì‹¤!"',
    'ìŠ¤í† ë¦¬í˜•: ê°œì¸ ê²½í—˜ë‹´ìœ¼ë¡œ ì‹œì‘ â†’ "ì €ë„ ì²˜ìŒì—” ì´ë¬ì–´ìš”..."',
    'ì§ˆë¬¸í˜•: í•µì‹¬ ì§ˆë¬¸ìœ¼ë¡œ ì‹œì‘ â†’ "ì™œ OOì€ í•­ìƒ ì‹¤íŒ¨í• ê¹Œìš”?"',
    'ì•½ì†í˜•: ì–»ì„ ê°€ì¹˜ ì œì‹œ â†’ "ì´ ê¸€ì„ ì½ìœ¼ë©´ OOì„ ì•Œ ìˆ˜ ìˆì–´ìš”"',
  ],

  // ë³¸ë¡  êµ¬ì¡° íŒ¨í„´
  bodyPatterns: [
    'ë¬¸ì œ-í•´ê²°: ë¬¸ì œ ì œì‹œ â†’ ì›ì¸ ë¶„ì„ â†’ í•´ê²°ì±… ì œê³µ',
    'ë‹¨ê³„ë³„: Step 1, 2, 3... ìˆœì„œëŒ€ë¡œ ì„¤ëª…',
    'Before-After: ë³€í™” ì „í›„ ë¹„êµ',
    'ì¥ë‹¨ì : ì¥ì , ë‹¨ì , ê²°ë¡  êµ¬ì¡°',
    'ë¹„êµë¶„ì„: A vs B ìƒì„¸ ë¹„êµ',
  ],

  // ê²°ë¡  íŒ¨í„´ (CTA)
  conclusionPatterns: [
    'ìš”ì•½: í•µì‹¬ í¬ì¸íŠ¸ 3ì¤„ ìš”ì•½',
    'í–‰ë™ì´‰êµ¬: ì§€ê¸ˆ ë°”ë¡œ í•´ë³¼ ê²ƒ ì œì•ˆ',
    'ì§ˆë¬¸ìœ ë„: ëŒ“ê¸€ë¡œ ì˜ê²¬ ë¬»ê¸°',
    'ì˜ˆê³ : ë‹¤ìŒ ê¸€ ì˜ˆê³ ë¡œ êµ¬ë… ìœ ë„',
    'ê²©ë ¤: ë…ìì—ê²Œ ì‘ì›ì˜ ë©”ì‹œì§€',
  ],

  // ë¬¸ì²´ íŠ¹ì„±
  writingStyles: [
    'êµ¬ì–´ì²´: ~ê±°ë“ ìš”, ~ì–ì•„ìš”, ~í–ˆì–´ìš”',
    'ì¹œê·¼ê°: ì €, ìš°ë¦¬, ì—¬ëŸ¬ë¶„',
    'ì´ëª¨ì§€: ì ì ˆí•œ ìœ„ì¹˜ì— ê°ì • ì´ëª¨ì§€',
    'ê°•ì¡°: **ì¤‘ìš” í¬ì¸íŠ¸** ë³¼ë“œ ì²˜ë¦¬',
    'ì§ˆë¬¸: ë…ìì—ê²Œ ì§ì ‘ ë¬»ëŠ” í˜•ì‹',
  ],

  // ì‹ ë¢°ë„ ìš”ì†Œ
  trustElements: [
    'êµ¬ì²´ì  ìˆ«ì: "3ë…„ê°„ 100íšŒ ì´ìƒ í…ŒìŠ¤íŠ¸"',
    'ê°œì¸ ê²½í—˜: "ì œê°€ ì§ì ‘ í•´ë´¤ëŠ”ë°ìš”..."',
    'ì „ë¬¸ê°€ ì¸ìš©: "OO ì „ë¬¸ê°€ì— ë”°ë¥´ë©´..."',
    'ë°ì´í„° ì œì‹œ: "ì„¤ë¬¸ ê²°ê³¼ 78%ê°€..."',
    'ë¹„í¬ì• í”„í„°: ì‹¤ì œ ë³€í™” ì‚¬ë¡€ ì œì‹œ',
  ],
};

// ë„¤ì´ë²„ SEO ìµœì í™” ì „ëµ
const NAVER_SEO_STRATEGIES = {
  // ì œëª© ìµœì í™” (32ì ì´ë‚´)
  titleStrategies: [
    'í•µì‹¬ í‚¤ì›Œë“œ ì•ë°°ì¹˜',
    'ìˆ«ì í¬í•¨ (TOP 5, 3ê°€ì§€ ë“±)',
    'ì—°ë„ í¬í•¨ (2026ë…„)',
    'ê°ì • ìœ ë°œ ë‹¨ì–´ (ì™„ë²½, í•„ìˆ˜, ê¿€íŒ)',
    'ì§ˆë¬¸í˜• ë˜ëŠ” ë¦¬ìŠ¤íŠ¸í˜•',
  ],

  // ë³¸ë¬¸ í‚¤ì›Œë“œ ì „ëµ
  keywordStrategies: [
    'ë©”ì¸ í‚¤ì›Œë“œ: ì œëª©, ì²« ë¬¸ë‹¨, ì†Œì œëª©ì— ë°°ì¹˜',
    'ì—°ê´€ í‚¤ì›Œë“œ: ìì—°ìŠ¤ëŸ½ê²Œ 3-5íšŒ ë°˜ë³µ',
    'LSI í‚¤ì›Œë“œ: ê´€ë ¨ í‚¤ì›Œë“œ ë‹¤ì–‘í•˜ê²Œ ì‚¬ìš©',
    'ë¡±í…Œì¼ í‚¤ì›Œë“œ: êµ¬ì²´ì ì¸ ê²€ìƒ‰ì–´ í¬í•¨',
  ],

  // êµ¬ì¡° ìµœì í™”
  structureStrategies: [
    'H2 íƒœê·¸: ë©”ì¸ ì„¹ì…˜ (3-5ê°œ)',
    'H3 íƒœê·¸: ì„œë¸Œ ì„¹ì…˜',
    'ëª©ë¡: ul/olë¡œ ê°€ë…ì„± í–¥ìƒ',
    'êµµì€ ê¸€ì”¨: í•µì‹¬ í‚¤ì›Œë“œ ê°•ì¡°',
    'ì¸ìš©êµ¬: ì¤‘ìš” íŒì€ blockquote',
  ],

  // ê¸¸ì´ ë° í˜•ì‹
  formatStrategies: [
    'ë³¸ë¬¸ ê¸¸ì´: ìµœì†Œ 2000ì, ê¶Œì¥ 3000-5000ì',
    'ë‹¨ë½: 2-3ë¬¸ì¥ì”© ì§§ê²Œ',
    'ì¤„ë°”ê¿ˆ: ëª¨ë°”ì¼ ê°€ë…ì„± ê³ ë ¤',
    'ì´ë¯¸ì§€: 500-1000ìë§ˆë‹¤ 1ê°œ',
  ],
};

// ë² í…Œë‘ ì‘ê°€ í‡´ê³  ì›Œí¬í”Œë¡œìš°
const EDITING_WORKFLOW = {
  stages: [
    {
      name: '1ì°¨ í‡´ê³ : êµ¬ì¡° ê²€í† ',
      checks: [
        'ì„œë¡ -ë³¸ë¡ -ê²°ë¡  íë¦„ì´ ìì—°ìŠ¤ëŸ¬ìš´ê°€?',
        'ê° ì„¹ì…˜ì´ ë…¼ë¦¬ì ìœ¼ë¡œ ì—°ê²°ë˜ëŠ”ê°€?',
        'ë…ìê°€ ì–»ì–´ê°ˆ ê°€ì¹˜ê°€ ëª…í™•í•œê°€?',
      ],
    },
    {
      name: '2ì°¨ í‡´ê³ : ë¬¸ì¥ ë‹¤ë“¬ê¸°',
      checks: [
        'ë¬¸ì¥ì´ ë„ˆë¬´ ê¸¸ì§€ ì•Šì€ê°€? (25ì ì´ë‚´ ê¶Œì¥)',
        'ê°™ì€ í‘œí˜„ì´ ë°˜ë³µë˜ì§€ ì•ŠëŠ”ê°€?',
        'ì–´ìƒ‰í•œ í‘œí˜„ì´ ì—†ëŠ”ê°€?',
      ],
    },
    {
      name: '3ì°¨ í‡´ê³ : ë…ì ê´€ì ',
      checks: [
        'ì´ˆë³´ìë„ ì´í•´í•  ìˆ˜ ìˆëŠ”ê°€?',
        'ì „ë¬¸ ìš©ì–´ì— ì„¤ëª…ì´ ìˆëŠ”ê°€?',
        'ì‹¤ì œë¡œ ë„ì›€ì´ ë˜ëŠ” ì •ë³´ì¸ê°€?',
      ],
    },
    {
      name: '4ì°¨ í‡´ê³ : SEO ìµœì í™”',
      checks: [
        'í‚¤ì›Œë“œê°€ ì ì ˆíˆ ë°°ì¹˜ë˜ì—ˆëŠ”ê°€?',
        'ì œëª©ì´ í´ë¦­ì„ ìœ ë°œí•˜ëŠ”ê°€?',
        'ë©”íƒ€ ì„¤ëª…ì´ ë§¤ë ¥ì ì¸ê°€?',
      ],
    },
    {
      name: '5ì°¨ í‡´ê³ : ìµœì¢… ì ê²€',
      checks: [
        'ì˜¤íƒˆìëŠ” ì—†ëŠ”ê°€?',
        'AI ëŠë‚Œì´ ë‚˜ì§€ ì•ŠëŠ”ê°€?',
        'ì´ë¯¸ì§€/ë§í¬ê°€ ì •ìƒì¸ê°€?',
      ],
    },
  ],
};

// íŒŒì›Œë¸”ë¡œê±° ìŠ¤íƒ€ì¼ ê¸€ ìƒì„± í”„ë¡¬í”„íŠ¸
const POWER_BLOGGER_PROMPT = `ë‹¹ì‹ ì€ ì›” 1000ë§Œì› ì´ìƒ ìˆ˜ìµì„ ì˜¬ë¦¬ëŠ” ëŒ€í•œë¯¼êµ­ TOP íŒŒì›Œë¸”ë¡œê±°ì…ë‹ˆë‹¤.
300ëª…ì˜ ì„±ê³µí•œ íŒŒì›Œë¸”ë¡œê±°ë“¤ì˜ ê¸€ì“°ê¸° íŒ¨í„´ì„ ì™„ë²½íˆ ë§ˆìŠ¤í„°í–ˆìŠµë‹ˆë‹¤.

## ğŸ¯ í˜„ì¬ ì—°ë„: ${CURRENT_YEAR}ë…„ (ì—°ë„ ì–¸ê¸‰ ì‹œ ë°˜ë“œì‹œ ${CURRENT_YEAR}ë…„ ì‚¬ìš©)

## ğŸ“Š íŒŒì›Œë¸”ë¡œê±° ê¸€ì“°ê¸° íŒ¨í„´ ë¶„ì„

### ì„œë¡  íŒ¨í„´ (ë°˜ë“œì‹œ í•˜ë‚˜ ì„ íƒ)
${POWER_BLOGGER_PATTERNS.introPatterns.map((p, i) => `${i + 1}. ${p}`).join('\n')}

### ë³¸ë¡  êµ¬ì¡° (ë°˜ë“œì‹œ í•˜ë‚˜ ì„ íƒ)
${POWER_BLOGGER_PATTERNS.bodyPatterns.map((p, i) => `${i + 1}. ${p}`).join('\n')}

### ê²°ë¡  íŒ¨í„´ (ë°˜ë“œì‹œ í•˜ë‚˜ ì„ íƒ)
${POWER_BLOGGER_PATTERNS.conclusionPatterns.map((p, i) => `${i + 1}. ${p}`).join('\n')}

### ë¬¸ì²´ íŠ¹ì„± (ëª¨ë‘ ì ìš©)
${POWER_BLOGGER_PATTERNS.writingStyles.map((s, i) => `${i + 1}. ${s}`).join('\n')}

### ì‹ ë¢°ë„ ìš”ì†Œ (ìµœì†Œ 3ê°œ í¬í•¨)
${POWER_BLOGGER_PATTERNS.trustElements.map((t, i) => `${i + 1}. ${t}`).join('\n')}

## ğŸ” ë„¤ì´ë²„ SEO ìµœì í™” ì „ëµ

### ì œëª© ì „ëµ
${NAVER_SEO_STRATEGIES.titleStrategies.map((s, i) => `${i + 1}. ${s}`).join('\n')}

### í‚¤ì›Œë“œ ì „ëµ
${NAVER_SEO_STRATEGIES.keywordStrategies.map((s, i) => `${i + 1}. ${s}`).join('\n')}

### êµ¬ì¡° ì „ëµ
${NAVER_SEO_STRATEGIES.structureStrategies.map((s, i) => `${i + 1}. ${s}`).join('\n')}

### í˜•ì‹ ì „ëµ
${NAVER_SEO_STRATEGIES.formatStrategies.map((s, i) => `${i + 1}. ${s}`).join('\n')}

## âœï¸ ë² í…Œë‘ ì‘ê°€ í‡´ê³  ì²´í¬ë¦¬ìŠ¤íŠ¸
${EDITING_WORKFLOW.stages.map(stage => `
### ${stage.name}
${stage.checks.map(c => `- ${c}`).join('\n')}`).join('\n')}

## ğŸ“ ì‘ì„± ìš”ì²­

ì£¼ì œ: {TOPIC}
ì œëª© ì´ˆì•ˆ: {TITLE}
ì¹´í…Œê³ ë¦¬: {CATEGORY}
íƒ€ê²Ÿ í‚¤ì›Œë“œ: {KEYWORDS}

## âš ï¸ í•„ìˆ˜ ìš”êµ¬ì‚¬í•­

1. **AI ëŠë‚Œ ì ˆëŒ€ ê¸ˆì§€**
   - "~ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤", "~í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤" ê°™ì€ ë”±ë”±í•œ í‘œí˜„ ê¸ˆì§€
   - "~ê±°ë“ ìš”", "~ì–ì•„ìš”", "~í–ˆì–´ìš”" ê°™ì€ ìì—°ìŠ¤ëŸ¬ìš´ ì¢…ê²°ì–´ë¯¸ ì‚¬ìš©
   - "ì €", "ì œê°€", "ìš°ë¦¬" ë“± 1ì¸ì¹­ ì ê·¹ ì‚¬ìš©

2. **ì‹¤ì œ ê²½í—˜ë‹´ í•„ìˆ˜**
   - ìµœì†Œ 2ê°œì˜ ê°œì¸ ê²½í—˜ ìŠ¤í† ë¦¬
   - êµ¬ì²´ì ì¸ ë‚ ì§œ/ì¥ì†Œ/ìƒí™© ë¬˜ì‚¬
   - ì‹¤íŒ¨ë‹´ê³¼ ì„±ê³µë‹´ ëª¨ë‘ í¬í•¨

3. **êµ¬ì²´ì  ì •ë³´ ì œê³µ**
   - ìˆ«ì, ë°ì´í„°, í†µê³„ í™œìš©
   - ì‹¤í–‰ ê°€ëŠ¥í•œ êµ¬ì²´ì ì¸ íŒ
   - ë…ìê°€ ë°”ë¡œ ì ìš©í•  ìˆ˜ ìˆëŠ” ì •ë³´

4. **ê°ì • ì—°ê²°**
   - ë…ìì˜ ê³ ë¯¼/ë¬¸ì œì— ê³µê°
   - í•´ê²°í–ˆì„ ë•Œì˜ ê¸°ì¨ ë¬˜ì‚¬
   - ì‘ì›ê³¼ ê²©ë ¤ì˜ ë©”ì‹œì§€

5. **SEO ìµœì í™”**
   - ë©”ì¸ í‚¤ì›Œë“œ ì œëª©ê³¼ ì²« ë¬¸ë‹¨ì— ë°°ì¹˜
   - H2, H3 íƒœê·¸ë¡œ êµ¬ì¡°í™”
   - 2000ì ì´ìƒ, ê¶Œì¥ 3500ì ì´ìƒ

## ğŸ“¤ ì¶œë ¥ í˜•ì‹ (JSON)

{
  "title": "SEO ìµœì í™”ëœ ì œëª© (32ì ì´ë‚´)",
  "content": "HTML í˜•ì‹ ë³¸ë¬¸ (3500ì ì´ìƒ)",
  "metaDescription": "ê²€ìƒ‰ ê²°ê³¼ ì„¤ëª… (150ì ì´ë‚´)",
  "hashtags": ["#í•´ì‹œíƒœê·¸1", "#í•´ì‹œíƒœê·¸2", ...],
  "selectedPatterns": {
    "intro": "ì„ íƒí•œ ì„œë¡  íŒ¨í„´",
    "body": "ì„ íƒí•œ ë³¸ë¡  êµ¬ì¡°",
    "conclusion": "ì„ íƒí•œ ê²°ë¡  íŒ¨í„´"
  },
  "trustElementsUsed": ["ì‚¬ìš©í•œ ì‹ ë¢°ë„ ìš”ì†Œë“¤"],
  "estimatedReadTime": "ì˜ˆìƒ ì½ê¸° ì‹œê°„ (ë¶„)"
}`;

// íŒŒì›Œë¸”ë¡œê±° ìŠ¤íƒ€ì¼ ì½˜í…ì¸  ìƒì„±
export async function generatePowerBloggerContent(
  topic: TopicSuggestion
): Promise<{
  title: string;
  content: string;
  metaDescription: string;
  hashtags: string[];
  patterns: {
    intro: string;
    body: string;
    conclusion: string;
  };
  trustElements: string[];
  readTime: string;
}> {
  const prompt = POWER_BLOGGER_PROMPT
    .replace('{TOPIC}', topic.topic)
    .replace('{TITLE}', topic.title)
    .replace('{CATEGORY}', topic.category)
    .replace('{KEYWORDS}', topic.keywords.join(', '));

  try {
    const response = await callGeminiPremium(prompt);
    const jsonMatch = response.match(/\{[\s\S]*\}/);

    if (jsonMatch) {
      const parsed = JSON.parse(jsonMatch[0]);

      return {
        title: parsed.title || topic.title,
        content: cleanHtmlContent(parsed.content || ''),
        metaDescription: parsed.metaDescription || '',
        hashtags: parsed.hashtags || [],
        patterns: parsed.selectedPatterns || {
          intro: 'ê³µê°í˜•',
          body: 'ë¬¸ì œ-í•´ê²°',
          conclusion: 'ìš”ì•½',
        },
        trustElements: parsed.trustElementsUsed || [],
        readTime: parsed.estimatedReadTime || '5ë¶„',
      };
    }
  } catch (error) {
    console.error('Power blogger content generation error:', error);
  }

  throw new Error('Failed to generate power blogger content');
}

// HTML ì •ë¦¬
function cleanHtmlContent(content: string): string {
  let cleaned = content;
  cleaned = cleaned.replace(/```html\n?/g, '').replace(/```\n?/g, '');
  cleaned = cleaned.replace(/\n{3,}/g, '\n\n');
  cleaned = cleaned.replace(/<\/?article[^>]*>/g, '');
  return cleaned.trim();
}

// íŠ¸ë Œë“œ ì£¼ì œ ì„ ì • (ìœ í–‰ + ë¹„ì¤‘ë³µ)
export async function selectTrendingTopic(
  recentTopics: string[],
  category: string
): Promise<string> {
  const prompt = `í˜„ì¬ ${CURRENT_YEAR}ë…„ ${new Date().getMonth() + 1}ì›” ê¸°ì¤€ìœ¼ë¡œ
ê°€ì¥ ê²€ìƒ‰ëŸ‰ì´ ë†’ê³  ê´€ì‹¬ë„ê°€ ë†’ì€ ${category} ê´€ë ¨ ë¸”ë¡œê·¸ ì£¼ì œë¥¼ ì„ ì •í•´ì£¼ì„¸ìš”.

## ìµœê·¼ ì‘ì„±ëœ ì£¼ì œ (ì¤‘ë³µ ë°©ì§€)
${recentTopics.map(t => `- ${t}`).join('\n')}

## ìš”êµ¬ì‚¬í•­
1. ìœ„ ì£¼ì œë“¤ê³¼ ê²¹ì¹˜ì§€ ì•ŠëŠ” ìƒˆë¡œìš´ ì£¼ì œ
2. í˜„ì¬ íŠ¸ë Œë“œì— ë§ëŠ” ì£¼ì œ
3. ê²€ìƒ‰ëŸ‰ì´ ë†’ì€ ì£¼ì œ
4. ë…ìì—ê²Œ ì‹¤ì§ˆì  ê°€ì¹˜ë¥¼ ì œê³µí•˜ëŠ” ì£¼ì œ

## ì‘ë‹µ í˜•ì‹
ì„ ì •ëœ ì£¼ì œë§Œ í•œ ì¤„ë¡œ ì‘ë‹µ (ì„¤ëª… ì—†ì´)`;

  try {
    const response = await callGeminiPremium(prompt);
    return response.trim().replace(/^["']|["']$/g, '');
  } catch (error) {
    console.error('Trending topic selection error:', error);
    return `${CURRENT_YEAR}ë…„ ${category} ì™„ë²½ ê°€ì´ë“œ`;
  }
}

export { POWER_BLOGGER_PATTERNS, NAVER_SEO_STRATEGIES, EDITING_WORKFLOW };
